name: Deploy Backend and Frontend

on:
  workflow_dispatch:  
  workflow_call:
    inputs:
      image_tag:
        required: false
        type: string

jobs:
  docker:
    runs-on: [self-hosted, splitzy]
    steps:
      - name: Update Runner Secrets
        env:
          APP_SETTINGS: ${{ secrets.APP_SETTINGS }}
        run: |
          echo "$APP_SETTINGS" | sudo tee /opt/splitzy/appsettings.ci.json
        
      # - name: Deploy
      #   run: /opt/splitzy/scripts/deploy.sh 
      - name : Deploy Services
        run: |
          docker image prune -af 
          docker stop ui api || true
          docker rm ui api || true

          docker run -d --name api -v /opt/splitzy/appsettings.json:/app/appsettings.Production.json --network splitzy --hostname server --restart unless-stopped rghvgrv/splitzy-api

          docker run -d --name ui --network splitzy --hostname ui --restart unless-stopped rghvgrv/splitzy-ui
      